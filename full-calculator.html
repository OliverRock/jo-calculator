<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Affordability Calculator</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Page-specific styles for Full Calculator */
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: help;
        }
        
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            width: 280px;
            font-size: 0.85rem;
            font-weight: normal;
            line-height: 1.5;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100;
            transition: opacity 0.2s, visibility 0.2s;
        }
        
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--primary);
        }
        
        .tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        
        @media (max-width: 600px) {
            .tooltip-content {
                left: 0;
                transform: translateX(0);
            }
            .tooltip-content::after {
                left: 20px;
            }
        }
        
        /* Budget Breakdown */
        .budget-breakdown {
            margin-top: 20px;
        }
        
        .budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg);
        }
        
        .budget-item:last-child {
            border-bottom: none;
        }
        
        .budget-item-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .budget-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .budget-item-value {
            font-weight: 600;
        }
        
        .budget-total {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }
        
        .budget-total.over-budget {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        /* Visual Bar Chart */
        .budget-visual {
            height: 40px;
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
        }
        
        .budget-visual-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            transition: width 0.3s ease;
            min-width: 0;
            overflow: hidden;
        }
        
        /* Comparison Section */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 600px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .scenario-card {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .scenario-card.with-fees {
            background: #fff5f5;
            border: 2px solid #fed7d7;
        }
        
        .scenario-card.no-fees {
            background: #f0fff4;
            border: 2px solid #c6f6d5;
        }
        
        .scenario-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        .scenario-highlight {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .scenario-card.with-fees .scenario-highlight { color: var(--danger); }
        .scenario-card.no-fees .scenario-highlight { color: var(--accent); }
        
        .scenario-price {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .scenario-detail {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .comparison-result {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }
        
        .comparison-result .amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4ade80;
            margin: 10px 0;
        }
        
        /* First-time buyer toggle */
        .first-time-buyer-toggle {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg);
            border-radius: 8px;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .toggle-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* Upfront Costs */
        .costs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (max-width: 600px) {
            .costs-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .cost-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .cost-item-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        .cost-item-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .total-upfront {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }
        
        .total-upfront .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .total-upfront .amount {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 5px;
        }
        
        /* Lending Check */
        .lending-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 600px) {
            .lending-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .lending-stat {
            background: var(--bg);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .lending-stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        .lending-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .lending-stat-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        /* Money Left Over */
        .money-left {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .money-left.positive {
            background: var(--accent-light);
            border: 2px solid var(--accent);
        }
        
        .money-left.negative {
            background: var(--danger-light);
            border: 2px solid var(--danger);
        }
        
        .money-left-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .money-left.positive .money-left-label { color: #155724; }
        .money-left.negative .money-left-label { color: #721c24; }
        
        .money-left-amount {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .money-left.positive .money-left-amount { color: var(--accent); }
        .money-left.negative .money-left-amount { color: var(--danger); }
    </style>
</head>
<body>

<nav class="main-nav">
    <div class="nav-container">
        <a href="index.html" class="nav-link">Simple Calculator</a>
        <a href="full-calculator.html" class="nav-link active">Full Calculator</a>
        <a href="commute.html" class="nav-link">Commute Maps</a>
    </div>
</nav>

<div class="page-content">
<div class="container">
    <header>
        <h1>Home Affordability Calculator</h1>
        <p>Full breakdown for self-employed buyers</p>
    </header>

    <!-- SECTION 1: Income -->
    <div class="card">
        <h2 class="card-title">Your Income</h2>
        <div class="input-grid">
            <div class="input-group">
                <label for="monthlyIncome">Expected Monthly Income (after tax)</label>
                <input type="number" id="monthlyIncome" value="2800" oninput="calculate()">
                <div class="hint">Your average monthly take-home as self-employed</div>
            </div>
            <div class="input-group">
                <label for="annualIncome">Annual Income (for mortgage calc)</label>
                <input type="number" id="annualIncome" value="30000" oninput="calculate()">
                <div class="hint">Average of last 2-3 years (before tax)</div>
            </div>
        </div>
        
        <!-- Lending Reality -->
        <div class="lending-grid">
            <div class="lending-stat">
                <div class="lending-stat-label">Max Mortgage (Self-Employed)</div>
                <div class="lending-stat-value" id="maxMortgage">£220,000</div>
                <div class="lending-stat-note">Based on 4x annual income</div>
            </div>
            <div class="lending-stat">
                <div class="lending-stat-label">Max Property Price</div>
                <div class="lending-stat-value" id="maxPropertyPrice">£620,000</div>
                <div class="lending-stat-note">With your deposit</div>
            </div>
        </div>
    </div>

    <!-- SECTION 2: Monthly Budget -->
    <div class="card">
        <h2 class="card-title">Maximum Monthly Housing Budget</h2>
        <div class="input-grid">
            <div class="input-group full-width">
                <label for="maxBudget">Maximum you want to spend per month</label>
                <input type="number" id="maxBudget" value="850" oninput="calculate()">
                <div class="hint">Total for mortgage + service charge + council tax + utilities</div>
            </div>
        </div>
        
        <!-- Affordability Indicator -->
        <div style="margin-top: 25px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-weight: 600;">Housing as % of Income</span>
                <div class="tooltip">
                    <span class="tooltip-icon">?</span>
                    <div class="tooltip-content">
                        <strong>This is the most important question to ask yourself.</strong><br><br>
                        A lower percentage means more financial flexibility for unexpected expenses, savings, and peace of mind. You should choose something you feel comfortable with.
                    </div>
                </div>
            </div>
            <span id="affordabilityPercent" style="font-size: 1.5rem; font-weight: 700;">37.5%</span>
        </div>
        
        <div class="status-box" id="affordabilityStatus">
            <div class="status-title">Comfortable</div>
            <div>You're within the recommended range. Lenders will view this favourably.</div>
        </div>
    </div>

    <!-- SECTION 3: Monthly Costs Breakdown -->
    <div class="card">
        <h2 class="card-title">Monthly Costs Breakdown</h2>
        <div class="input-grid">
            <div class="input-group">
                <label for="serviceCharge">Service Charge (monthly)</label>
                <input type="number" id="serviceCharge" value="300" oninput="calculate()">
                <div class="hint">£0 for freehold properties</div>
            </div>
            <div class="input-group">
                <label for="councilTax">Council Tax (monthly)</label>
                <input type="number" id="councilTax" value="150" oninput="calculate()">
                <div class="hint">Band D in most London boroughs: £140-180</div>
            </div>
            <div class="input-group">
                <label for="utilities">Utilities (monthly)</label>
                <input type="number" id="utilities" value="200" oninput="calculate()">
                <div class="hint">Gas, electric, water, broadband</div>
            </div>
            <div class="input-group">
                <label for="interestRate">Interest Rate (%)</label>
                <input type="number" id="interestRate" value="4.5" step="0.1" oninput="calculate()">
                <div class="hint">Current mortgage rate</div>
            </div>
        </div>
        
        <!-- Visual Budget Bar -->
        <div class="budget-visual" id="budgetVisual">
            <div class="budget-visual-segment" style="background: #3498db;" id="vizMortgage">Mortgage</div>
            <div class="budget-visual-segment" style="background: #e74c3c;" id="vizService">Service</div>
            <div class="budget-visual-segment" style="background: #9b59b6;" id="vizCouncil">Council</div>
            <div class="budget-visual-segment" style="background: #f39c12;" id="vizUtilities">Utilities</div>
        </div>
        
        <!-- Budget Breakdown List -->
        <div class="budget-breakdown">
            <div class="budget-item">
                <div class="budget-item-label">
                    <span class="budget-dot" style="background: #3498db;"></span>
                    <span>Mortgage Payment</span>
                </div>
                <div class="budget-item-value" id="mortgagePayment">£850</div>
            </div>
            <div class="budget-item">
                <div class="budget-item-label">
                    <span class="budget-dot" style="background: #e74c3c;"></span>
                    <span>Service Charge</span>
                </div>
                <div class="budget-item-value" id="serviceChargeDisplay">£300</div>
            </div>
            <div class="budget-item">
                <div class="budget-item-label">
                    <span class="budget-dot" style="background: #9b59b6;"></span>
                    <span>Council Tax</span>
                </div>
                <div class="budget-item-value" id="councilTaxDisplay">£150</div>
            </div>
            <div class="budget-item">
                <div class="budget-item-label">
                    <span class="budget-dot" style="background: #f39c12;"></span>
                    <span>Utilities</span>
                </div>
                <div class="budget-item-value" id="utilitiesDisplay">£200</div>
            </div>
        </div>
        
        <div class="budget-total" id="budgetTotal">
            <span>Total Monthly Housing Cost</span>
            <span id="totalMonthlyCost">£1,500</span>
        </div>
        
        <!-- Money Left Over -->
        <div class="money-left positive" id="moneyLeftBox">
            <div class="money-left-label">Money left after housing costs</div>
            <div class="money-left-amount" id="moneyLeft">£2,500</div>
        </div>
    </div>

    <!-- SECTION 4: Property & Deposit -->
    <div class="card">
        <h2 class="card-title">Your Deposit</h2>
        <div class="input-grid">
            <div class="input-group">
                <label for="deposit">Cash Deposit</label>
                <input type="number" id="deposit" value="400000" oninput="calculate()">
            </div>
            <div class="input-group">
                <label for="mortgageTerm">Mortgage Term (years)</label>
                <input type="number" id="mortgageTerm" value="25" oninput="calculate()">
            </div>
        </div>
    </div>

    <!-- SECTION 5: Property Comparison -->
    <div class="card">
        <h2 class="card-title">What Can You Afford?</h2>
        
        <div class="comparison-grid">
            <div class="scenario-card with-fees">
                <div class="scenario-label">Flat with Service Charge</div>
                <div class="scenario-highlight">Paying £<span id="scAmount">300</span>/mo in fees</div>
                <div class="scenario-price" id="priceWithFees">£525,000</div>
                <div class="scenario-detail">Mortgage: £<span id="mortgageWithFees">125,000</span></div>
            </div>
            <div class="scenario-card no-fees">
                <div class="scenario-label">Freehold / No Service Charge</div>
                <div class="scenario-highlight">£0 in fees</div>
                <div class="scenario-price" id="priceNoFees">£580,000</div>
                <div class="scenario-detail">Mortgage: £<span id="mortgageNoFees">180,000</span></div>
            </div>
        </div>
        
        <div class="comparison-result">
            <div>Avoiding service charges lets you afford</div>
            <div class="amount">+£<span id="priceDifference">55,000</span></div>
            <div>more property for the same monthly cost</div>
        </div>
    </div>

    <!-- SECTION 6: Upfront Costs -->
    <div class="card">
        <h2 class="card-title">Upfront Costs (No Service Charge Scenario)</h2>
        
        <div class="first-time-buyer-toggle">
            <label class="toggle-label">
                <input type="checkbox" id="firstTimeBuyer" checked onchange="calculate()">
                <span class="toggle-text">First-time buyer</span>
            </label>
            <div class="hint" id="ftbHint">No stamp duty up to £300,000, then 5% up to £500,000</div>
        </div>
        
        <div class="costs-grid">
            <div class="cost-item">
                <div class="cost-item-label">Stamp Duty</div>
                <div class="cost-item-value" id="stampDuty">£9,000</div>
            </div>
            <div class="cost-item">
                <div class="cost-item-label">Legal Fees (est.)</div>
                <div class="cost-item-value">£2,000</div>
            </div>
            <div class="cost-item">
                <div class="cost-item-label">Survey (est.)</div>
                <div class="cost-item-value">£500</div>
            </div>
        </div>
        
        <div class="total-upfront">
            <div class="label">Total Cash Needed to Move</div>
            <div class="amount" id="totalUpfront">£411,500</div>
        </div>
        <div class="hint" style="text-align: center; margin-top: 10px;">Deposit + Stamp Duty + Legal + Survey</div>
    </div>

    <!-- SECTION 7: Lending Check -->
    <div class="card">
        <h2 class="card-title">Lending Reality Check</h2>
        
        <div class="status-box" id="lendingStatus">
            <div class="status-title">Checking...</div>
            <div id="lendingMessage">Calculating based on your income...</div>
        </div>
        
        <div class="lending-grid" style="margin-top: 20px;">
            <div class="lending-stat">
                <div class="lending-stat-label">Mortgage Needed (No Fees)</div>
                <div class="lending-stat-value" id="mortgageNeeded">£180,000</div>
            </div>
            <div class="lending-stat">
                <div class="lending-stat-label">Your Max Mortgage</div>
                <div class="lending-stat-value" id="yourMaxMortgage">£220,000</div>
            </div>
        </div>
    </div>

    <div class="footer-note">
        <p><strong>Note:</strong> This calculator provides estimates only. Self-employed mortgage applications typically require 2-3 years of accounts. Actual lending decisions depend on many factors including credit history, existing debts, and lender criteria.</p>
        <p>Stamp duty rates from April 2025. First-time buyer relief available on properties up to £500,000.</p>
    </div>
</div>
</div>

<script>
    function calculate() {
        // Get all inputs
        const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;
        const annualIncome = parseFloat(document.getElementById('annualIncome').value) || 0;
        const maxBudget = parseFloat(document.getElementById('maxBudget').value) || 0;
        const serviceCharge = parseFloat(document.getElementById('serviceCharge').value) || 0;
        const councilTax = parseFloat(document.getElementById('councilTax').value) || 0;
        const utilities = parseFloat(document.getElementById('utilities').value) || 0;
        const deposit = parseFloat(document.getElementById('deposit').value) || 0;
        const interestRate = parseFloat(document.getElementById('interestRate').value) || 4.5;
        const mortgageTerm = parseFloat(document.getElementById('mortgageTerm').value) || 25;

        // Constants
        const months = mortgageTerm * 12;
        const monthlyRate = (interestRate / 100) / 12;

        // === LENDING CALCULATIONS ===
        const maxMortgage = annualIncome * 4;
        const maxPropertyPrice = maxMortgage + deposit;
        
        document.getElementById('maxMortgage').textContent = formatCurrency(maxMortgage);
        document.getElementById('maxPropertyPrice').textContent = formatCurrency(maxPropertyPrice);

        // === AFFORDABILITY CALCULATIONS ===
        const affordabilityPercent = monthlyIncome > 0 ? (maxBudget / monthlyIncome) * 100 : 0;
        document.getElementById('affordabilityPercent').textContent = affordabilityPercent.toFixed(1) + '%';
        
        // Update affordability status
        const statusBox = document.getElementById('affordabilityStatus');
        if (affordabilityPercent <= 30) {
            statusBox.className = 'status-box success';
            statusBox.innerHTML = '<div class="status-title">Comfortable</div><div>You\'re within the recommended range. Lenders will view this favourably.</div>';
        } else if (affordabilityPercent <= 40) {
            statusBox.className = 'status-box warning';
            statusBox.innerHTML = '<div class="status-title">Stretched</div><div>This is manageable but leaves less room for savings or unexpected costs.</div>';
        } else {
            statusBox.className = 'status-box danger';
            statusBox.innerHTML = '<div class="status-title">High Risk</div><div>Spending over 40% on housing may be difficult to sustain. Consider reducing your budget.</div>';
        }

        // === MORTGAGE CALCULATION (with service charge) ===
        const fixedCosts = serviceCharge + councilTax + utilities;
        const availableForMortgage = Math.max(maxBudget - fixedCosts, 0);
        
        let mortgagePrincipalWithFees = 0;
        if (availableForMortgage > 0 && monthlyRate > 0) {
            mortgagePrincipalWithFees = availableForMortgage * ((Math.pow(1 + monthlyRate, months) - 1) / (monthlyRate * Math.pow(1 + monthlyRate, months)));
        }
        const propertyPriceWithFees = deposit + mortgagePrincipalWithFees;

        // === MORTGAGE CALCULATION (no service charge) ===
        const fixedCostsNoService = councilTax + utilities;
        const availableForMortgageNoService = Math.max(maxBudget - fixedCostsNoService, 0);
        
        let mortgagePrincipalNoFees = 0;
        if (availableForMortgageNoService > 0 && monthlyRate > 0) {
            mortgagePrincipalNoFees = availableForMortgageNoService * ((Math.pow(1 + monthlyRate, months) - 1) / (monthlyRate * Math.pow(1 + monthlyRate, months)));
        }
        const propertyPriceNoFees = deposit + mortgagePrincipalNoFees;

        // === BUDGET BREAKDOWN ===
        const mortgagePayment = availableForMortgage;
        const totalMonthlyCost = mortgagePayment + serviceCharge + councilTax + utilities;
        
        document.getElementById('mortgagePayment').textContent = formatCurrency(mortgagePayment);
        document.getElementById('serviceChargeDisplay').textContent = formatCurrency(serviceCharge);
        document.getElementById('councilTaxDisplay').textContent = formatCurrency(councilTax);
        document.getElementById('utilitiesDisplay').textContent = formatCurrency(utilities);
        document.getElementById('totalMonthlyCost').textContent = formatCurrency(totalMonthlyCost);
        
        // Budget total styling
        const budgetTotalEl = document.getElementById('budgetTotal');
        if (totalMonthlyCost > maxBudget) {
            budgetTotalEl.className = 'budget-total over-budget';
        } else {
            budgetTotalEl.className = 'budget-total';
        }

        // Visual budget bar
        const total = mortgagePayment + serviceCharge + councilTax + utilities;
        if (total > 0) {
            document.getElementById('vizMortgage').style.width = (mortgagePayment / total * 100) + '%';
            document.getElementById('vizService').style.width = (serviceCharge / total * 100) + '%';
            document.getElementById('vizCouncil').style.width = (councilTax / total * 100) + '%';
            document.getElementById('vizUtilities').style.width = (utilities / total * 100) + '%';
        }

        // Money left over
        const moneyLeft = monthlyIncome - totalMonthlyCost;
        const moneyLeftBox = document.getElementById('moneyLeftBox');
        document.getElementById('moneyLeft').textContent = formatCurrency(moneyLeft);
        
        if (moneyLeft >= 0) {
            moneyLeftBox.className = 'money-left positive';
        } else {
            moneyLeftBox.className = 'money-left negative';
        }

        // === COMPARISON ===
        document.getElementById('scAmount').textContent = serviceCharge.toLocaleString('en-GB');
        document.getElementById('priceWithFees').textContent = formatCurrency(propertyPriceWithFees);
        document.getElementById('mortgageWithFees').textContent = formatNumber(mortgagePrincipalWithFees);
        document.getElementById('priceNoFees').textContent = formatCurrency(propertyPriceNoFees);
        document.getElementById('mortgageNoFees').textContent = formatNumber(mortgagePrincipalNoFees);
        
        const priceDiff = propertyPriceNoFees - propertyPriceWithFees;
        document.getElementById('priceDifference').textContent = formatNumber(priceDiff);

        // === STAMP DUTY ===
        const isFirstTimeBuyer = document.getElementById('firstTimeBuyer').checked;
        const stampDutyResult = calculateStampDuty(propertyPriceNoFees, isFirstTimeBuyer);
        document.getElementById('stampDuty').textContent = formatCurrency(stampDutyResult.duty);
        
        // Update hint text based on FTB status
        const ftbHint = document.getElementById('ftbHint');
        if (isFirstTimeBuyer) {
            if (propertyPriceNoFees > 500000) {
                ftbHint.textContent = 'Property over £500,000 — first-time buyer relief does not apply';
                ftbHint.style.color = '#e74c3c';
            } else {
                ftbHint.textContent = 'No stamp duty up to £300,000, then 5% up to £500,000';
                ftbHint.style.color = '';
            }
        } else {
            ftbHint.textContent = 'Standard rates: 0% up to £125,000, 2% to £250,000, then 5% to £925,000';
            ftbHint.style.color = '';
        }
        
        const totalUpfront = deposit + stampDutyResult.duty + 2000 + 500;
        document.getElementById('totalUpfront').textContent = formatCurrency(totalUpfront);

        // === LENDING CHECK ===
        document.getElementById('mortgageNeeded').textContent = formatCurrency(mortgagePrincipalNoFees);
        document.getElementById('yourMaxMortgage').textContent = formatCurrency(maxMortgage);
        
        const lendingStatus = document.getElementById('lendingStatus');
        const lendingMessage = document.getElementById('lendingMessage');
        
        if (mortgagePrincipalNoFees <= maxMortgage) {
            lendingStatus.className = 'status-box success';
            lendingStatus.querySelector('.status-title').textContent = 'Looks Achievable';
            lendingMessage.textContent = `The mortgage you need (${formatCurrency(mortgagePrincipalNoFees)}) is within your likely lending limit of ${formatCurrency(maxMortgage)}.`;
        } else {
            const shortfall = mortgagePrincipalNoFees - maxMortgage;
            lendingStatus.className = 'status-box danger';
            lendingStatus.querySelector('.status-title').textContent = 'May Be Difficult';
            lendingMessage.textContent = `You need ${formatCurrency(mortgagePrincipalNoFees)} but may only qualify for ${formatCurrency(maxMortgage)}. Consider reducing your budget or increasing your deposit by ${formatCurrency(shortfall)}.`;
        }
    }

    function calculateStampDuty(price, isFirstTimeBuyer) {
        let duty = 0;
        let originalPrice = price;
        
        if (isFirstTimeBuyer && price <= 500000) {
            // First-time buyer relief (from April 2025)
            // Only applies if property £500,000 or less
            // Up to £300,000: 0%
            // £300,001 to £500,000: 5%
            if (price > 300000) {
                duty = (price - 300000) * 0.05;
            }
        } else {
            // Standard residential rates (from April 2025)
            // Up to £125,000: 0%
            // £125,001 to £250,000: 2%
            // £250,001 to £925,000: 5%
            // £925,001 to £1.5m: 10%
            // Over £1.5m: 12%
            
            if (price > 1500000) {
                duty += (price - 1500000) * 0.12;
                price = 1500000;
            }
            if (price > 925000) {
                duty += (price - 925000) * 0.10;
                price = 925000;
            }
            if (price > 250000) {
                duty += (price - 250000) * 0.05;
                price = 250000;
            }
            if (price > 125000) {
                duty += (price - 125000) * 0.02;
            }
        }
        
        return { duty: Math.floor(duty), price: originalPrice };
    }

    function formatCurrency(num) {
        return '£' + Math.floor(num).toLocaleString('en-GB');
    }

    function formatNumber(num) {
        return Math.floor(num).toLocaleString('en-GB');
    }

    // Initial calculation
    calculate();
</script>

</body>
</html>
